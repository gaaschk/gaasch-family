generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ── Auth.js required models ──────────────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  role          String    @default("pending")  // "pending" | "viewer" | "editor" | "admin"
  password      String?                        // bcrypt hash; null until /set-password step
  tokenVersion  Int       @default(0)          // incremented to force re-login
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts  Account[]
  sessions  Session[]
  auditLogs AuditLog[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ── Family history models ────────────────────────────────────────────────────

model Person {
  id          String   @id  // e.g. "@I500001@"
  name        String
  sex         String?
  birthDate   String?  @map("birth_date")
  birthPlace  String?  @map("birth_place")
  deathDate   String?  @map("death_date")
  deathPlace  String?  @map("death_place")
  burialPlace String?  @map("burial_place")
  burialDate  String?  @map("burial_date")
  occupation  String?
  notes       String?
  narrative   String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  asHusband Family[]      @relation("FamilyHusband")
  asWife    Family[]      @relation("FamilyWife")
  childIn   FamilyChild[]

  @@map("people")
}

model Family {
  id        String   @id  // e.g. "@F500001@"
  husband   Person?  @relation("FamilyHusband", fields: [husbId], references: [id])
  husbId    String?  @map("husb_id")
  wife      Person?  @relation("FamilyWife", fields: [wifeId], references: [id])
  wifeId    String?  @map("wife_id")
  marrDate  String?  @map("marr_date")
  marrPlace String?  @map("marr_place")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  children FamilyChild[]

  @@map("families")
}

model FamilyChild {
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  familyId String @map("family_id")
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId String @map("person_id")

  @@id([familyId, personId])
  @@map("family_children")
}

model Setting {
  key       String   @id          // e.g. "anthropic_api_key", "anthropic_model"
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model AuditLog {
  id        String   @id @default(cuid())
  tableName String   @map("table_name")
  recordId  String   @map("record_id")
  action    String   // "create" | "update" | "delete"
  oldData   String?  @map("old_data")   // JSON stored as text (SQLite has no native JSON)
  newData   String?  @map("new_data")
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?  @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_log")
}
